name: "üöÄ VO-SE Cut Studio: Absolute Professional Build"

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-build:
    name: üíé Quality Gate & Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true 
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Advanced Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Install Hardened Dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip wheel setuptools
          for i in {1..3}; do
            pip install -r requirements.txt && break || sleep 5
          done

      - name: üõ°Ô∏è Strict Linting & Auto-Fix (Ruff)
        shell: bash
        run: |
          # 1. Ëá™Âãï‰øÆÊ≠£„ÇíÈÅ©Áî®
          ruff check . --select E,F,W,I --fix
          ruff format .
          
          # 2. ‰øÆÊ≠£Âæå„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™çÔºà„Åæ„Å†Ê±ö„Çå„Åå„ÅÇ„Çå„Å∞„ÄÅ„Åì„Åì„Åß„Ç®„É©„Éº„Å®„Åó„Å¶ËêΩ„Å®„ÅôÔºâ
          ruff check . --select E,F,W,I
          ruff format . --check
          
      - name: üß™ Strict Type Intelligence (Pyright)
        shell: bash
        run: |
          # pyrightconfig.json „Åå„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇÂé≥Ê†º„Å´„ÉÅ„Çß„ÉÉ„ÇØ
          pyright .

      - name: üõ†Ô∏è Native Core Compilation
        shell: bash
        run: |
          mkdir -p bin
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # WindowsÊúÄÈÅ©Âåñ: AVX2, ÈùôÁöÑ„É™„É≥„ÇØ„Å´„Çà„Çã„Éù„Éº„Çø„Éì„É™„ÉÜ„Ç£Á¢∫‰øù
            g++ -std=c++17 -shared -fPIC -o bin/libvo_se_cut.dll src/core/*.cpp \
                -Iinclude -O3 -mavx2 -static -static-libgcc -static-libstdc++
          else
            # MacÊúÄÈÅ©Âåñ: „Éç„Ç§„ÉÜ„Ç£„Éñ„Éì„É´„Éâ
            clang++ -std=c++17 -shared -fPIC -o bin/libvo_se_cut.dylib src/core/*.cpp \
                    -Iinclude -O3 -undefined dynamic_lookup -w
          fi

      - name: üèÅ Deep Integration Test (Headless)
        shell: bash
        run: |
          export QT_QPA_PLATFORM=offscreen
          printf "%s\n" \
            "import sys, os, ctypes" \
            "from PySide6.QtWidgets import QApplication" \
            "from PySide6.QtCore import QTimer" \
            "print(f'Platform: {sys.platform}')" \
            "try:" \
            "    lib_name = 'libvo_se_cut.' + ('dll' if sys.platform=='win32' else 'dylib')" \
            "    lib_path = os.path.abspath(os.path.join('bin', lib_name))" \
            "    if os.path.exists(lib_path):" \
            "        ctypes.CDLL(lib_path)" \
            "        print('SUCCESS: Core Library Loaded')" \
            "    else:" \
            "        print(f'WARNING: Core Library not found at {lib_path}')" \
            "    app = QApplication(sys.argv)" \
            "    from main_window import CutStudioMain" \
            "    window = CutStudioMain()" \
            "    print('SUCCESS: GUI Classes Initialized')" \
            "    QTimer.singleShot(500, lambda: (print('Event Loop Test OK'), app.quit()))" \
            "    sys.exit(app.exec())" \
            "except Exception as e:" \
            "    print(f'CRITICAL FAILURE: {e}')" \
            "    import traceback; traceback.print_exc()" \
            "    sys.exit(1)" > deep_test.py
          python deep_test.py

      - name: üì¶ Final Packaging (PyInstaller)
        shell: bash
        run: |
          mkdir -p dist_out
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            pyinstaller --noconsole --onefile --clean \
              --add-data "bin/libvo_se_cut.dll;bin" \
              --add-data "assets;assets" \
              --name "VO-SE_Cut_Studio_Win" main.py
            mv dist/VO-SE_Cut_Studio_Win.exe dist_out/
          else
            pyinstaller --noconsole --windowed --clean \
              --add-data "bin/libvo_se_cut.dylib:bin" \
              --add-data "assets:assets" \
              --name "VO-SE_Cut_Studio_Mac" main.py
            find dist/ -name "*.dylib" -exec codesign --force --deep --sign - {} \;
            codesign --force --deep --sign - "dist/VO-SE_Cut_Studio_Mac.app"
            cd dist && zip -ry ../dist_out/VO-SE_Cut_Studio_Mac.zip VO-SE_Cut_Studio_Mac.app && cd ..
          fi

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Release-${{ matrix.os }}
          path: dist_out/

  release:
    name: üåç Global Distribution
    needs: check-and-build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: final_assets
          merge-multiple: true

      - name: Create Official Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            final_assets/*.exe
            final_assets/*.zip
          body: |
            ## VO-SE Cut Studio Official Release
            - Automated Type & Lint Checks: PASSED
            - Native Core Integration: VERIFIED
            - Cross-Platform Build: SUCCESS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
