name: "ğŸš€ VO-SE Cut Studio: Absolute Professional Build"

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-build:
    name: ğŸ’ Quality Gate & Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true # 1ã¤ã§ã‚‚ã‚³ã‚±ãŸã‚‰å³ä¸­æ­¢ã€‚å¦¥å”ã¯è¨±ã•ãªã„ã€‚
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã®ã€Œã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆã€è¨­å®š
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä¸å®‰å®šã•ã‚’è€ƒæ…®ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ˜ç¤º
          cache-dependency-path: '**/requirements.txt'

      # ä¸‡ãŒä¸€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ãŸæ™‚ã®ãŸã‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ã‚’è¿½åŠ 
      - name: Install dependencies with Retry
        run: |
          for i in {1..3}; do
            python -m pip install --upgrade pip wheel && \
            pip install -r requirements.txt && break || sleep 5
          done.0

      # --- 1. é™çš„è§£æãƒ•ã‚§ãƒ¼ã‚º (Zero Tolerance) ---
      - name: ğŸ›¡ï¸ Strict Linting (Ruff)
        run: ruff check . --select E,F,W,I --target-version py310

      - name: ğŸ§ª Strict Type Intelligence (Pyright)
        run: pyright .

      # --- 2. ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ•ã‚§ãƒ¼ã‚º (Native Optimization) ---
      - name: ğŸ› ï¸ Native Core Compilation
        shell: bash
        run: |
          mkdir -p bin
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows: AVX2å‘½ä»¤ã‚»ãƒƒãƒˆç­‰ã€ç¾ä»£ã®CPUã«æœ€é©åŒ–
            g++ -std=c++17 -shared -fPIC -o bin/libvo_se_cut.dll src/core/*.cpp \
                -Iinclude -O3 -mavx2 -static -static-libgcc -static-libstdc++
          else
            # Mac: Universal Binary (Intel/Apple Silicon) ã‚’æ„è­˜ã—ãŸãƒ“ãƒ«ãƒ‰
            clang++ -std=c++17 -shared -fPIC -o bin/libvo_se_cut.dylib src/core/*.cpp \
                    -Iinclude -O3 -Xpreprocessor -fopenmp -undefined dynamic_lookup
          fi

      # --- 3. å‹•çš„æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º (Deep Smoke Test) ---
      - name: ğŸ Deep Integration Test
        shell: bash
        run: |
          export QT_QPA_PLATFORM=offscreen
          # å˜ãªã‚‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆã ã‘ã§ãªãã€å®Ÿéš›ã«Qtã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã¾ã§æ¤œè¨¼
          printf "%s\n" \
            "import sys, os, ctypes" \
            "from PySide6.QtWidgets import QApplication" \
            "from PySide6.QtCore import QTimer" \
            "try:" \
            "    # 1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ­ãƒ¼ãƒ‰æ¤œè¨¼" \
            "    lib_path = os.path.join('bin', 'libvo_se_cut.' + ('dll' if sys.platform=='win32' else 'dylib'))" \
            "    ctypes.CDLL(os.path.abspath(lib_path))" \
            "    # 2. GUIã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—èµ·å‹•æ¤œè¨¼" \
            "    app = QApplication(sys.argv)" \
            "    from main_window import CutStudioMain" \
            "    window = CutStudioMain()" \
            "    QTimer.singleShot(100, lambda: (print('Event Loop OK'), app.quit()))" \
            "    sys.exit(app.exec())" \
            "except Exception as e:" \
            "    print(f'CRITICAL FAILURE: {e}')" \
            "    sys.exit(1)" > deep_test.py
          python deep_test.py

      # --- 4. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚° & ç½²å (Distribution Readiness) ---
      - name: ğŸ“¦ Final Packaging
        shell: bash
        run: |
          mkdir -p dist_out
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            pyinstaller --noconsole --onefile --clean \
              --add-data "bin/libvo_se_cut.dll;bin" \
              --add-data "assets;assets" \
              --icon "assets/icon.ico" \
              --name "VO-SE_Cut_Studio_Win" main.py
            mv dist/VO-SE_Cut_Studio_Win.exe dist_out/
          else
            pyinstaller --noconsole --windowed --clean \
              --add-data "bin/libvo_se_cut.dylib:bin" \
              --add-data "assets:assets" \
              --icon "assets/icon.icns" \
              --name "VO-SE_Cut_Studio_Mac" main.py
            # macOSç‰¹æœ‰ã®ç½²åä¿®å¾© (Gatekeeperå¯¾ç­–)
            find dist/ -name "*.dylib" -exec codesign --force --deep --sign - {} \;
            codesign --force --deep --sign - "dist/VO-SE_Cut_Studio_Mac.app"
            cd dist && zip -ry ../dist_out/VO-SE_Cut_Studio_Mac.zip VO-SE_Cut_Studio_Mac.app && cd ..
          fi

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Release-${{ matrix.os }}
          path: dist_out/

  release:
    name: ğŸŒ Global Distribution
    needs: check-and-build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Collect All Binaries
        uses: actions/download-artifact@v4
        with:
          path: final_assets
          merge-multiple: true

      - name: Create Official Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            final_assets/*.exe
            final_assets/*.zip
          body: "VO-SE Cut Studio Official Build. All checks passed."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
